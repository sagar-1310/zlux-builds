name: "Build and Test core"
description: "This action helps build and test zlux-core"
inputs:
  zlux-app-manager:
    description: 'zlux-app-manager PR number'
    required: false
  zlux-app-server:
    description: 'zlux-app-server PR number'
    required: false
  zlux-build:
    description: 'zlux-build PR number'
    required: false
  zlux-platform:
    description: 'zlux-platform PR number'
    required: false
  zlux-server-framework:
    description: 'zlux-server-framework PR number'
    required: false
  zlux-shared:
    description: 'zlux-shared PR number'
    required: false
    
    

runs:
  using: "composite"
  steps:
    - name: 'checkout'
      run: |
        mkdir zlux && cd zlux
        git clone https://github.com/zowe/zlux-app-manager.git -b $CURRENT_BRANCH
        git clone https://github.com/zowe/zlux-app-server.git -b $CURRENT_BRANCH
        git clone https://github.com/zowe/zlux-build.git -b $CURRENT_BRANCH
        git clone https://github.com/zowe/zlux-platform.git -b $CURRENT_BRANCH
        git clone https://github.com/zowe/zlux-server-framework.git -b $CURRENT_BRANCH
        git clone https://github.com/zowe/zlux-shared.git -b $CURRENT_BRANCH
      shell: bash    
        
    - name: 'set version'
      run: |
        version=$(echo $ZOWE_VERSION | grep -o '[^-]*$')
        majorVersion=$(echo $version | cut -d. -f1)
        minorVersion=$(echo $version | cut -d. -f2)
        microVersion=$(echo $version | cut -d. -f3)
        cd zlux/zlux-build
        sed -i -e "s/MAJOR_VERSION=0/MAJOR_VERSION=${majorVersion}/" \
                 -e "s/MINOR_VERSION=8/MINOR_VERSION=${minorVersion}/" \
                 -e "s/REVISION=4/REVISION=${microVersion}/" \
                  version.properties
        echo "Set version to:"
        cat version.properties
      shell: bash  

    - name: 'build'
      run: |
        cd zlux/zlux-build
        bash -c set -o pipefail && ant production 2>&1 | grep -vE "^\s+\[exec\]\s+0\% compiling"
      shell: bash 
      
    - name: 'package'
      run: |
        chmod +x dist/zlux-build/*.sh
        cd dist
        tar cf ../zlux.tar -H ustar *
        cd ..
        git clone -b feature/tag-script https://github.com/1000TurquoisePogs/zowe-install-packaging.git
        export MVD_HOME_DIR=$(pwd) 
        echo MVD_HOME_DIR=$(pwd) >> $GITHUB_ENV
      shell: bash